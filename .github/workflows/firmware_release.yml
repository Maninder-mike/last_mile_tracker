name: Firmware Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to release (manual run only)'
        required: true
        default: 'v0.0.0-manual'

permissions:
  contents: write

jobs:
  quality:
    name: Pre-Release Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Linter (Ruff)
        run: |
          ruff check firmware_esp32/

  release:
    name: Publish Release
    needs: quality
    runs-on: ubuntu-latest
    # If triggered manually, use input tag. If pushed tag, use ref_name.
    env:
      VERSION_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Artifacts
        run: |
          echo "Preparing release for version: $VERSION_TAG"
          mkdir -p release_artifacts
          
          # 1. Main OTA Script (Raw)
          cp firmware_esp32/main.py release_artifacts/main.py
          
          # 2. Full Source Archive (Versioned Name)
          # Naming convention: firmware_<version>.zip
          ARCHIVE_NAME="firmware_${VERSION_TAG}.zip"
          
          cd firmware_esp32
          zip -r "../release_artifacts/$ARCHIVE_NAME" . -x "*.git*" "*.DS_Store" "venv/*" "__pycache__/*"
          cd ..
          
          echo "Artifacts prepared:"
          ls -l release_artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: |
            release_artifacts/main.py
            release_artifacts/firmware_*.zip
          generate_release_notes: true
          draft: false      # Set to true if you want to verify before publishing
          prerelease: false # Set based on tag format? (e.g. v1.0.0-beta)
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
