name: Firmware ESP32

on:
  push:
    branches: [ "main" ]
    paths:
      - 'firmware_esp32/**'
      - '.github/workflows/firmware_esp32.yml'
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'firmware_esp32/**'
      - '.github/workflows/firmware_esp32.yml'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to release (manual run only)'
        required: true
        default: 'v0.0.0-manual'

permissions:
  contents: write

jobs:
  quality:
    name: Lint & Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Linter (Ruff)
        run: |
          ruff check firmware_esp32/
      - name: Check Format (Ruff)
        run: |
          ruff format firmware_esp32/ --check

  security_scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit
        run: bandit -r firmware_esp32/ -c firmware_esp32/pyproject.toml

  static_typing:
    name: Static Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Mypy
        run: pip install mypy

      - name: Run Mypy
        run: mypy firmware_esp32/ --config-file firmware_esp32/pyproject.toml

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Pytest
        run: pip install pytest

      - name: Run Tests
        run: pytest firmware_esp32/tests/

  build:
    name: Build & Package
    needs: [quality, security_scan, static_typing, test]
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        # ... (lines 65-85 unchanged internally)
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag_name }}" >> $GITHUB_OUTPUT
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            LATEST=$(git tag -l 'fw-v*' --sort=-v:refname | head -n 1)
            if [ -z "$LATEST" ]; then
              NEW_TAG="fw-v0.0.1"
            else
              VERSION=${LATEST#fw-v}
              IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
              PATCH=$((PATCH + 1))
              NEW_TAG="fw-v${MAJOR}.${MINOR}.${PATCH}"
            fi
            echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Size Guard
        run: |
          SIZE=$(du -sb firmware_esp32/ | cut -f1)
          THRESHOLD=512000 # 500KB
          echo "Firmware size: $SIZE bytes (Threshold: $THRESHOLD)"
          if [ "$SIZE" -gt "$THRESHOLD" ]; then
            echo "::error::Firmware size $SIZE exceeds threshold $THRESHOLD!"
            exit 1
          fi

      - name: Prepare Artifacts
        run: |
          mkdir -p dist
          VERSION_TAG="${{ steps.version.outputs.tag }}"
          echo "Packing version: $VERSION_TAG"
          echo "$VERSION_TAG" > dist/VERSION
          ARCHIVE_NAME="firmware_${VERSION_TAG}.zip"
          cd firmware_esp32
          zip -r "../dist/$ARCHIVE_NAME" . -x "*.git*" "*.DS_Store" "venv/*" "__pycache__/*"
          cd ..
          cp firmware_esp32/main.py dist/main.py
          sha256sum dist/main.py | awk '{print $1}' > dist/main.py.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifacts
          path: dist/
          retention-days: 1

  release:
    name: Publish Release
    needs: build
    # Run on tag pushes, manual dispatch, OR pushes to main with firmware changes
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    env:
      VERSION_TAG: ${{ needs.build.outputs.version_tag }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-artifacts
          path: release_artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          files: |
            release_artifacts/main.py
            release_artifacts/main.py.sha256
            release_artifacts/*.zip
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: Cleanup Old Releases
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Delete Older Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old firmware releases, keeping the last 3..."
          
          # Only target fw-v* releases
          RELEASES_TO_DELETE=$(gh release list --limit 50 --json tagName --order desc --template '{{range .}}{{printf "%s\n" .tagName}}{{end}}' | grep '^fw-v' | tail -n +4)
          
          if [ -z "$RELEASES_TO_DELETE" ]; then
            echo "No old firmware releases to delete."
          else
            echo "Deleting the following releases:"
            echo "$RELEASES_TO_DELETE"
            
            for tag in $RELEASES_TO_DELETE; do
              echo "Deleting $tag..."
              gh release delete "$tag" --yes --cleanup-tag
            done
          fi
